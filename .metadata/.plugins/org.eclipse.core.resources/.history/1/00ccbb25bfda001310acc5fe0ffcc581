#include "rwmake.ch"
#include "topconn.ch"
#include "tbiconn.ch" 
#include "protheus.ch" 

User Function ADJIN79()          

Local cPerg := "ADJIN79"

If !Pergunte(cPerg)
	Return
Endif

SFT->(DBSELECTAREA("SFT"))
SFT->(DBSETORDER(6))
SFT->(DBGOTOP())  

cQuery := " SELECT FT_FILIAL, FT_TIPOMOV, FT_NFISCAL, FT_SERIE, COUNT(FT_ITEM) AS QTDEITEM,FT_VALCONT, FT_ISENICM, FT_PRCUNIT, FT_TOTAL, FT_BASEPIS, FT_BASECOF, SUM(E1_VALOR) AS E1_VALOR" 
cQuery += " FROM "+RETSQLNAME("SFT")+" SFT" 
cQuery += " JOIN "+RETSQLNAME("SE1")+" SE1 ON SE1.D_E_L_E_T_ != '*'"
cQuery += " AND SE1.E1_FILIAL = SFT.FT_FILIAL" 
cQuery += " AND SE1.E1_PREFIXO = SFT.FT_SERIE"  
cQuery += " AND SE1.E1_NUM = SFT.FT_NFISCAL " 
cQuery += " AND SE1.E1_CLIENTE = SFT.FT_CLIEFOR"
cQuery += " AND SE1.E1_LOJA = SFT.FT_LOJA"
cQuery += " WHERE SFT.D_E_L_E_T_ != '*'" 
cQuery += " AND FT_ENTRADA BETWEEN '"+DTOS(MV_PAR01)+"' AND '"+DTOS(MV_PAR02)+"' " 
cQuery += " AND FT_SERIE = '21' "
cQuery += " GROUP BY FT_FILIAL, FT_TIPOMOV, FT_NFISCAL, FT_SERIE, FT_VALCONT, FT_ISENICM, FT_PRCUNIT, FT_TOTAL, FT_BASEPIS, FT_BASECOF " 

dbUseArea(.T., "TOPCONN", TCGenQry(, , cQuery), "TRB", .F., .T.)

Do While TRB->(!EOF())
    
		If SFT->(DBSEEK(TRB->FT_FILIAL+TRB->FT_TIPOMOV+TRB->FT_NFISCAL+TRB->FT_SERIE))
	    	
			SFT->(Reclock("SFT", .F.))
			  
			  SFT->FT_VALCONT 	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_ISENICM  	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_PRCUNIT  	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_TOTAL		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_BASEPIS		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_BASECOF		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_VALIMP5		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_VALIMP6  	:= TRB->E1_VALOR / TRB->QTDEITEM
				
			SFT->(msUnLock())
		
		EndIf		
				
	TRB->(DBSKIP())
Enddo     
	
MSGINFO("Processamento OK V2!")
    
	TRB->(DBCLOSEAREA())

Return


User Function ADJFNAT()

SE1->(DBSELECTAREA("SE1"))
SE1->(DBSETORDER(2))
SE1->(DBGOTOP())  

cQuery := " SELECT E1_FILIAL,E1_CLIENTE,E1_LOJA,E1_PREFIXO,E1_NUM,E1_PARCELA,E1_TIPO,E1_NATUREZ, Z9_NATBX "                                                                                              
cQuery += " FROM SE1010 SE1 "
cQuery += " JOIN SC5010 SC5 ON SC5.D_E_L_E_T_ != '*' AND SC5.C5_FILIAL = SE1.E1_FILIAL AND SC5.C5_NUM = SE1.E1_PEDIDO AND SC5.C5_CLIENTE = SE1.E1_CLIENTE AND SE1.E1_LOJA = SC5.C5_LOJACLI "
cQuery += " JOIN SZ9010 SZ9 ON SZ9.D_E_L_E_T_ != '*' AND SC5.C5_FILIAL = SE1.E1_FILIAL AND SZ9.Z9_TIPOOP = SC5.C5_TIPOOP " 
cQuery += " WHERE SE1.D_E_L_E_T_ != '*' AND SE1.D_E_L_E_T_ != '*'  AND SE1.E1_EMISSAO BETWEEN '20140101' AND '20140513' "
cQuery += " AND E1_NATUREZ != Z9_NATBX " 
cQuery += " AND E1_PARCELA = 'A' --AND C5_TIPOOP = '44' "
cQuery += " ORDER BY E1_EMISSAO "

dbUseArea(.T., "TOPCONN", TCGenQry(, , cQuery), "TRB", .F., .T.)

Do While TRB->(!EOF())
    
		If SE1->(DBSEEK( TRB->E1_FILIAL + TRB->E1_CLIENTE + TRB->E1_LOJA + TRB->E1_PREFIXO + TRB->E1_NUM + TRB->E1_PARCELA + TRB->E1_TIPO ))
	    	
			SFT->(Reclock("SFT", .F.))
			  
			  SFT->FT_VALCONT 	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_ISENICM  	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_PRCUNIT  	:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_TOTAL		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_BASEPIS		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_BASECOF		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_VALIMP5		:= TRB->E1_VALOR / TRB->QTDEITEM
			  SFT->FT_VALIMP6  	:= TRB->E1_VALOR / TRB->QTDEITEM
				
			SFT->(msUnLock())
		
		EndIf		
				
	TRB->(DBSKIP())
Enddo     
	
MSGINFO("Processamento OK V2!")
    
	TRB->(DBCLOSEAREA())

Return  