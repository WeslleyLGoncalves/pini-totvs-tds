#include "rwmake.ch"
#include "topconn.ch"
#include "tbiconn.ch"
#include "Fileio.ch"
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  |Rfat133   ºAutor  ³Danilo C S Pala     º Data ³  20120628   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ PiniProtheusService, clientes de SP sem inscricao estadual º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Pini                                                       º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Rfat133()
Private cSerie := space(3)
Private dDaData := dDatabase
Private dAteData := dDatabase
Private cEstado := space(2)
Private cNomeArquivo := space(50)

@ 000,000 TO 320,400 DIALOG oDlg TITLE "Parametros para arquivo" 
@ 001,005 TO 310,380
@ 005,010 SAY "Da Data:"
@ 005,070 GET dDaData
@ 020,010 SAY "Ate Data"
@ 020,070 GET dAteData 
@ 035,010 SAY "Estado"
@ 035,070 GET cEstado PICTURE "@!"
@ 065,010 SAY "Arquivo de saída:"
@ 065,070 GET cNomeArquivo  Picture "@!"
@ 075,070 SAY "Exemplo C:\inscr.CSV"
@ 115,010 BUTTON "Gerar Arquivo" SIZE 40,20 ACTION Processa({||GerarArquivo()})
@ 115,070 BUTTON "Sair" SIZE 40,20 Action ( Close(oDlg) )
Activate Dialog oDlg centered
Return
                
Static Function GerarArquivo()
Local cArquivo 	:= CriaTrab(,.F.)
Local oExcelApp
Local nHandle
Local cCrLf 	:= Chr(13) + Chr(10)
Local nX
local _cArq		:= ""
Private cQuery := ""


nHandle := MsfCreate(Alltrim(cNomeArquivo),0)
	
If nHandle > 0
	// Grava o cabecalho do arquivo
	fWrite(nHandle, "DATALOTE;CODIGO;LOJA;NOME;CPFCNPJ;IE")
	fWrite(nHandle, cCrLf ) // Pula linha

	CQuery := "select substr(to_char(p.datalotews,'dd/MM/yyyy'),1,10) as datalote, a1_cod, a1_loja, a1_nome, a1_cgc, a1_inscr "
	CQuery += " from "+ RetSqlName("SA1") +" sa1, pinipedido p where a1_filial='"+ XFILIAL("SA1") +"' and a1_cod=substr(p.codclientepini,1,6) and a1_loja=substr(p.codclientepini,7,2) and sa1.d_e_l_e_t_<>'*' "
	CQuery += " and p.datalotews>= to_date('"+ dtos(dDaData) +"','yyyyMMdd') and p.datalotews<=to_date('"+ dtos(dAteData) +"','yyyyMMdd')"
	CQuery += " and length(rtrim(a1_cgc)) >11 and a1_inscr='                  ' and a1_est='"+ cEstado +"'"
	
	If Select("TRBIE") <> 0
		DbSelectArea("TRBIE")
		DbCloseArea()
	EndIf
	
	//TCQUERY cQuery NEW ALIAS "TRBIE"
	DbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), "TRBIE", .T., .F. )
	TcSetField("TRBIE","DATALOTE","C",10,0)
	
	DbSelectArea("TRBIE")
	DBGOTOP()
	WHILE !EOF("TRBIE") 
		fWrite(nHandle, (TRBIE->DATALOTE) +";")
		fWrite(nHandle, ("'"+TRBIE->A1_COD) +";")
		fWrite(nHandle, ("'"+TRBIE->A1_LOJA) +";")
		fWrite(nHandle, LimparCSV(TRBIE->A1_NOME) +";")
		fWrite(nHandle, Transform(TRBIE->A1_CGC,"@R 999.999.999/9999-99"))
		fWrite(nHandle, LimparCSV(TRBIE->A1_INSCR) +";")
		fWrite(nHandle, cCrLf )

		DbSelectArea("TRBIE")
		DBSkip()
	END
	DbSelectArea("TRBIE")
	DbCloseArea()

	fClose(nHandle)
	//CpyS2T( cNomeArquivo , cPath, .T. )
		
	If ! ApOleClient( 'MsExcel' )
		MsgAlert( 'MsExcel nao instalado. Arquivo gerado: ' + alltrim(cNomeArquivo))
		Return
	EndIf
		
	oExcelApp := MsExcel():New()
	oExcelApp:WorkBooks:Open(alltrim(cNomeArquivo)) // Abre uma planilha
	oExcelApp:SetVisible(.T.)
Else
	MsgAlert("Falha na criação do arquivo")
Endif

Return 



Static Function LimparCSV(cTel)
cTel := upper(cTel)
cTel := Alltrim(StrTran(cTel,";",""))
Return cTel