#include "rwmake.ch"        // incluido pelo assistente de conversao do AP5 IDE em 25/02/02
/*/ //Danilo C S Pala 20051222: indices diferentes no ct2 em relacao ao si2
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ ±±
±±³Programa: PCONR01   ³Autor: Roger Cangianeli       ³ Data:   17/01/01 ³ ±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ±±
±±³Descri‡ao: Geracao do arquivo contabil para Srta.Cleide               ³ ±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ±±
±±³Uso      : M¢dulo de Contabilidade                                    ³ ±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
User Function Rfat034()        // incluido pelo assistente de conversao do AP5 IDE em 25/02/02

SetPrvt("_CALIAS,_NORD,_NREG,CPERG,_ACAMPOS,_CARQ")
SetPrvt("_CKEY,_CARQTRB,_CMSG,AREGS,I,J")

_cAlias := Alias()
_nOrd   := IndexOrd()
_nReg   := Recno()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis utilizadas para parametros                         ³
//³ mv_par01             // Mov.Contabil De                      ³
//³ mv_par02             // Mov.Contabil Ate                     ³
//³ mv_par03             // Conta Contabil De                    ³
//³ mv_par04             // Conta Contabil Ate                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cPerg := "CONR01"
//ValidPerg()

If !Pergunte(cPerg,.T.)
    Return
EndIf

Processa({|| _RunProc()},"Gerando Arquivo Contabil...")// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==>     Processa({||Execute(_RunProc)},"Gerando Arquivo Contabil...")

dbSelectArea(_cAlias)
dbSetOrder(_nOrd)
dbGoTo(_nReg)

Return

Static Function _RunProc()

_aCampos := {  {"PRODUTO",  "C",    15,     0} ,;
               {"CONTA",    "C",    20,     0} ,;
               {"VALOR",    "N",    15,     2} }

_cArq   := CriaTrab(_aCampos,.t.)
dbUseArea(.T.,, _cArq,"TRB",.F.,.F.)

_cKey   := "PRODUTO+CONTA"
IndRegua("TRB",_cArq,_cKey,,,"Selecionando Registros Temporarios...")

dbSelectArea("CT2")
ProcRegua(RecCount()/3)
dbSetOrder(2)           // Fil + Debito + Data
dbSeek( xFilial("CT2") + MV_PAR03 + DTOS(MV_PAR01), .T.)
While !Eof() .and. CT2->CT2_FILIAL == xFilial("CT2") .and. CT2->CT2_DEBITO <= MV_PAR04
    IncProc("Processando Registro "+ StrZero(Recno(),10))
    If CT2->CT2_DATA < MV_PAR01 .or. CT2->CT2_DATA > MV_PAR02
        dbSkip()
        Loop
    EndIf
    dbSelectArea("TRB")
    RecLock("TRB", .T.)
    TRB->PRODUTO    := CT2->CT2_PRODUTO
    TRB->CONTA      := CT2->CT2_DEBITO
    TRB->VALOR      := CT2->CT2_VALOR * -1
    msUnlock()
    dbSelectArea("CT2")
    dbSkip()
End

dbSelectArea("CT2")
dbSetOrder(3)           // Fil + Credito + Data
dbSeek( xFilial("CT2") + MV_PAR03 + DTOS(MV_PAR01), .T.)
While !Eof() .and. CT2->CT2_FILIAL == xFilial("CT2") .and. CT2->CT2_CREDIT <= MV_PAR04
    IncProc("Processando Registro "+ StrZero(Recno(),10))
    If CT2->CT2_DATA < MV_PAR01 .or. CT2->CT2_DATA > MV_PAR02
        dbSkip()
        Loop
    EndIf
    dbSelectArea("TRB")
    RecLock("TRB", .T.)
    TRB->PRODUTO    := CT2->CT2_PRODUTO
    TRB->CONTA      := CT2->CT2_CREDIT
    TRB->VALOR      := CT2->CT2_VALOR
    TRB->(msUnlock())
    dbSelectArea("CT2")
    dbSkip()
End

dbSelectArea("TRB")
If RecCount() > 0
    //If Upper(Subs(cUsuario,7,6)) == "CLEIDE"
    //    _cArqTrb :="F:\USUARIOS\CASC\GR"+AllTrim(Subs(MV_PAR03,1,4))+".DBF"
    //Else
        _cArqTrb :="\SIGA\EXPORTA\GR"+AllTrim(Subs(MV_PAR03,1,4))+".DBF"
    //EndIf
    Copy to &(_cArqTrb)
    _cMsg := "Arquivo "+_cArqTrb+" gerado com sucesso."
Else
    _cMsg := "Nao foram encontrados dados para a geracao do arquivo. Verifique"
    _cMsg := _cMsg + " os parametros e tente novamente."
EndIf

Alert(_cMsg)

dbSelectArea("TRB")
dbCloseArea()
fErase(_cArq+".DBF")
fErase(_cArq+OrdBagExt())

Return
/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±
±³Funcao    ³VALIDPERG³ Autor ³ Jose Renato July ³ Data ³ 25.01.99 ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±
±³Descricao ³ Verifica perguntas, incluindo-as caso nao existam.   ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±
±³Uso       ³ SX1                                                  ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±
±³Release   ³ 3.0i - Roger Cangianeli - 12/05/99.                  ³±
±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
Static Function VALIDPERG()

   cPerg    := PADR(cPerg,6)
   aRegs    := {}
   dbSelectArea("SX1")
   dbSetOrder(1)
   AADD(aRegs,{cPerg,"01","Mov.Contabil De     ?","mv_ch1","D",08,0,2,"G","","mv_par01","","","","","","","","","","","","","","",""})
   AADD(aRegs,{cPerg,"02","Mov.Contabil Ate    ?","mv_ch2","D",08,0,2,"G","","mv_par02","","","","","","","","","","","","","","",""})
   AADD(aRegs,{cPerg,"03","Conta Contabil De   ?","mv_ch3","C",20,0,2,"G","","mv_par03","","","","","","","","","","","","","","","CT1"})
   AADD(aRegs,{cPerg,"04","Conta Contabil Ate  ?","mv_ch4","C",20,0,2,"G","","mv_par04","","","","","","","","","","","","","","","CT1"})
   For i := 1 to Len(aRegs)
      If !dbSeek(cPerg+aRegs[i,2])
         RecLock("SX1",.T.)
         For j := 1 to FCount()
            If j <= Len(aRegs[i])
               FieldPut(j,aRegs[i,j])
            Endif
         Next
         SX1->(MsUnlock())
      Endif
   Next

Return