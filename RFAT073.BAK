#include "rwmake.ch"        // incluido pelo assistente de conversao do AP5 IDE em 25/02/02
#IFDEF WINDOWS
    #DEFINE SAY PSAY
#ENDIF

User Function Rfat073()        // incluido pelo assistente de conversao do AP5 IDE em 25/02/02

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Declaracao de variaveis utilizadas no programa atraves da funcao    ³
//³ SetPrvt, que criara somente as variaveis definidas pelo usuario,    ³
//³ identificando as variaveis publicas do sistema utilizadas no codigo ³
//³ Incluido pelo assistente de conversao do AP5 IDE                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

SetPrvt("_CALIAS,_NORDEM,_NREG,M_PAG,TAMANHO,LIMITE")
SetPrvt("TITULO,CDESC1,CDESC2,CDESC3,ARETURN,NOMEPROG")
SetPrvt("CPERG,NLASTKEY,WNREL,CSTRING,CCABEC1,CCABEC2")
SetPrvt("_ACAMPOS,_CARQ,NLIN,_CPREF,_NDUPL,_NTOTNF")
SetPrvt("_NTOTDUP,AREGS,I,J,")

#IFDEF WINDOWS
// Movido para o inicio do arquivo pelo assistente de conversao do AP5 IDE em 25/02/02 ==>     #DEFINE SAY PSAY
#ENDIF
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ ±±
±±³Programa: RFATR34   ³Autor: Roger Cangianeli       ³ Data:   21/09/00 ³ ±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ±±
±±³Descri‡ao: Relat¢rio de Conferencia de Notas Emitidas x Duplicatas    ³ ±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ±±
±±³Uso      : Especifico PINI                                            ³ ±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
_cAlias := Alias()
_nOrdem := IndexOrd()
_nReg   := Recno()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³   Parametros Utilizados                   ³
//³   mv_par01 = Nota Inicial                 ³
//³   mv_par02 = Nota Final                   ³
//³   mv_par03 = Serie                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
M_PAG    := 1
tamanho  := "P"
limite   := 80
titulo   := "FATURAMENTO X DUPLICATAS"
cDesc1   := "Este programa emite relat¢rio de Notas Fiscais por Duplicatas"
cDesc2   := " "
cDesc3   := " "

aReturn  := { "Especial", 1,"Administracao", 1, 2, 1,"",1 }
nomeprog := "RFATR34"

cPerg    := "FATR34"
ValidPerg()

If !Pergunte(CPERG)
   Return
EndIf
nLastKey := 0
wnrel    := "RFATR34"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica as perguntas selecionadas                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

CSTRING  := "SF2"
cCabec1  := "N O T A   F I S C A L      DUPLICATA"
cCabec2  := "Ser/Numero  Valor          Valor"
//           XXX/999999  99,999,999.99  99,999,999.99

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Envia controle para a funcao SETPRINT                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

wnrel := SetPrint(cString,wnrel,cPerg,Titulo,cDesc1,cDesc2,cDesc3,.T.)

If nLastKey == 27
   Return
EndIf

#IFDEF WINDOWS
    Processa({||_RunProc()}, "Selecionando Notas ...")// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==>     Processa({||Execute(_RunProc)}, "Selecionando Notas ...")
#ELSE
    _RunProc()
#ENDIF


dbSelectArea(_cAlias)
dbSetOrder(_nOrdem)
dbGoTo(_nReg)
Return


// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==> Function _RunProc
Static Function _RunProc()
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³  Prepara regua de impressÆo                                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

_aCampos := {{"SERIE"   ,"C",06,0},;
             {"NUM"     ,"C",06,0},;
             {"VALNF"   ,"N",16,2},;
             {"VALDUP"  ,"N",16,2}}

_cArq := CriaTrab(_aCampos,.t.)
dbUseArea(.T.,, _cArq,"TRB",.F.,.F.)
IndRegua("TRB",_cArq,"SERIE+NUM",,,"Selecionando registros .. ")

nLin   := 80

dbSelectArea("SF2")
dbSetOrder(1)
ProcRegua(RecCount())
dbSeek(xFilial("SF2")+MV_PAR01+MV_PAR03, .T.)
While !Eof() .and. SF2->F2_DOC <= MV_PAR02 .and. SF2->F2_FILIAL==xFilial("SF2")
    IncProc()

    If SF2->F2_SERIE #MV_PAR03
        dbSkip()
        Loop
    EndIf
** FALAR COM ROGER
    _cPref := ""
    dbSelectArea("SE1")
    dbSetOrder(2)
    If !dbSeek(xFilial("SE1")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_PREFIXO+SF2->F2_DOC, .F.)
        If dbSeek(xFilial("SE1")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_SERIE+SF2->F2_DOC, .F.)
            _cPref := SE1->E1_PREFIXO
        EndIf
    Else
        _cPref := "FAT"
    EndIf

    If !"P" $ SE1->E1_PEDIDO
        dbSelectArea("SC5")
        dbSetOrder(1)
        If dbSeek(xFilial("SC5")+SE1->E1_PEDIDO, .F.)
            If SC5->C5_DIVVEN #"PUBL"
                dbSelectArea("SF2")
                dbSkip()
                Loop
            EndIf
        Else
            dbSelectArea("SF2")
            dbSkip()
            Loop
        EndIf
    EndIf

    _nDupl := 0
    dbSelectArea("SE1")
    While !Eof() .and. SE1->E1_FILIAL == xFilial("SE1") .and.;
        SF2->F2_CLIENTE+SF2->F2_LOJA == SE1->E1_CLIENTE+SE1->E1_LOJA .and.;
        SE1->E1_NUM == SF2->F2_DOC .and. SE1->E1_PREFIXO == _cPref

        _nDupl := _nDupl + SE1->E1_VALOR

        dbSelectArea("SE1")
        dbSkip()
    End

    RecLock("TRB", .T.)
    TRB->SERIE  := SF2->F2_SERIE
    TRB->NUM    := SF2->F2_DOC
    TRB->VALNF  := SF2->F2_VALBRUT
    TRB->VALDUP := _nDupl
    trb->(msUnlock())

    dbSelectArea("SF2")
    dbSkip()

End

#IFDEF WINDOWS
    RptStatus({||_RunPrint()}, "Imprimindo Relacao de Notas...")// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==>     RptStatus({||Execute(_RunPrint)}, "Imprimindo Relacao de Notas...")
#ELSE
    _RunPrint()
#ENDIF
Return



// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==> Function _RunPrint
Static Function _RunPrint()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica Posicao do Formulario na Impressora                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

SetDefault(aReturn,cString)

If nLastKey == 27
   Return
EndIf

_nTotNF := 0
_nTotDup:= 0

DbSelectArea("TRB")
dbGoTop()
While !eof()

    If nLin > 58
       nLin     := Cabec(titulo,cCabec1,cCabec2,nomeprog,tamanho,18)
       nLin     := nLin + 2
    Endif

    @ nLin,000 psay AllTrim(TRB->SERIE)
    @ nLin,003 psay "/"+TRB->NUM
    @ nLin,013 psay TRB->VALNF   Picture "@E 99,999,999.99"
    @ nLin,028 psay TRB->VALDUP  Picture "@E 99,999,999.99"
    nLin     := nLin + 1
    _nTotNF := _nTotNF + TRB->VALNF
    _nTotDup:= _nTotDup + TRB->VALDUP

    dbSkip()

End

nLin    := nLin + 1
@ nLin,000 psay "========================================="
nLin    := nLin + 1
@ nLin,000 psay "TOTAL  -> "
@ nLin,013 psay _nTotNF  Picture "@E 99,999,999.99"
@ nLin,028 psay _nTotDup Picture "@E 99,999,999.99"
Eject

dbCloseArea()
fErase(_cArq+".DBF")
fErase(_cArq+OrdBagExt())

Set Device to Screen
If aReturn[5] == 1
    Set Printer To
    ourspool(wnrel)
Endif

MS_FLUSH()

Return


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±
±³Funcao    ³VALIDPERG³ Autor ³ Jose Renato July ³ Data ³ 25.01.99 ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±
±³Descricao ³ Verifica perguntas, incluindo-as caso nao existam.   ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±
±³Uso       ³ SX1                                                  ³±
±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±
±³Release   ³ 3.0i - Roger Cangianeli - 12/05/99.                  ³±
±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
// Substituido pelo assistente de conversao do AP5 IDE em 25/02/02 ==> Function VALIDPERG
Static Function VALIDPERG()

   cPerg    := PADR(cPerg,6)
   aRegs    := {}
   dbSelectArea("SX1")
   dbSetOrder(1)
   AADD(aRegs,{cPerg,"01","Nota Inicial       ?","mv_ch1","C",06,0,2,"G","","mv_par01","","","","","","","","","","","","","","",""})
   AADD(aRegs,{cPerg,"02","Nota Final         ?","mv_ch2","C",06,0,2,"G","","mv_par02","","","","","","","","","","","","","","",""})
   AADD(aRegs,{cPerg,"03","Serie das Notas    ?","mv_ch3","C",03,0,2,"G","","mv_par03","","","","","","","","","","","","","","",""})
   For i := 1 to Len(aRegs)
      If !dbSeek(cPerg+aRegs[i,2])
         RecLock("SX1",.T.)
         For j := 1 to FCount()
            If j <= Len(aRegs[i])
               FieldPut(j,aRegs[i,j])
            Endif
         Next
         sx1->(MsUnlock())
      Endif
   Next

Return

